# üìö Clase 1: AsyncStorage - Almacenamiento Clave-Valor

## üß≠ Navegaci√≥n del M√≥dulo

- **‚¨ÖÔ∏è Anterior**: [README del M√≥dulo](README.md)
- **‚û°Ô∏è Siguiente**: [Clase 2: SQLite - Base de Datos Relacional](clase_2_sqlite.md)
- **üè† [Volver al Inicio](../../README.md)**

---

## üéØ Objetivos de la Clase

- Comprender qu√© es AsyncStorage y cu√°ndo usarlo
- Implementar operaciones b√°sicas de almacenamiento (CRUD)
- Crear un servicio de almacenamiento reutilizable
- Manejar errores y casos edge
- Optimizar el rendimiento del almacenamiento

---

## üìñ Contenido Te√≥rico

### 1. ¬øQu√© es AsyncStorage?

AsyncStorage es una soluci√≥n de almacenamiento local para React Native que permite guardar datos en formato clave-valor de manera as√≠ncrona. Es ideal para:

- **Configuraciones de usuario** (tema, idioma, preferencias)
- **Datos de sesi√≥n** (tokens, informaci√≥n del usuario)
- **Cache de datos** (respuestas de API, im√°genes)
- **Configuraciones de la app** (primer uso, tutoriales)

**Caracter√≠sticas principales:**
- **As√≠ncrono**: No bloquea el hilo principal
- **Persistente**: Los datos sobreviven a reinicios de la app
- **Simple**: API f√°cil de usar con m√©todos b√°sicos
- **Universal**: Funciona en iOS y Android
- **L√≠mites**: Tiene restricciones de tama√±o en iOS

### 2. Instalaci√≥n y Configuraci√≥n

#### **Instalaci√≥n del Paquete:**
```bash
npm install @react-native-async-storage/async-storage
# o
yarn add @react-native-async-storage/async-storage
```

#### **Importaci√≥n en el C√≥digo:**
```javascript
import AsyncStorage from '@react-native-async-storage/async-storage';
```

---

## üõ†Ô∏è Implementaci√≥n Pr√°ctica

### 1. Servicio B√°sico de Almacenamiento

Vamos a crear un servicio completo que maneje todas las operaciones de AsyncStorage:

```javascript
// utils/storage.js
import AsyncStorage from '@react-native-async-storage/async-storage';

// Exportamos un objeto con m√©todos para manejar el almacenamiento
export const storage = {
  // M√©todo para guardar datos
  async setItem(key, value) {
    try {
      // JSON.stringify convierte cualquier valor a string
      // Esto es necesario porque AsyncStorage solo acepta strings
      await AsyncStorage.setItem(key, JSON.stringify(value));
    } catch (error) {
      // Capturamos cualquier error que pueda ocurrir
      console.error('Error saving data:', error);
      // Podr√≠amos lanzar el error para manejarlo en el componente
      throw error;
    }
  },

  // M√©todo para obtener datos
  async getItem(key) {
    try {
      // Obtenemos el valor almacenado
      const value = await AsyncStorage.getItem(key);
      
      // Si no hay valor, retornamos null
      if (value === null) {
        return null;
      }
      
      // Parseamos el JSON de vuelta a su tipo original
      return JSON.parse(value);
    } catch (error) {
      console.error('Error reading data:', error);
      return null;
    }
  },

  // M√©todo para eliminar un elemento espec√≠fico
  async removeItem(key) {
    try {
      await AsyncStorage.removeItem(key);
    } catch (error) {
      console.error('Error removing data:', error);
      throw error;
    }
  },

  // M√©todo para limpiar todo el almacenamiento
  async clear() {
    try {
      await AsyncStorage.clear();
    } catch (error) {
      console.error('Error clearing data:', error);
      throw error;
    }
  },

  // M√©todo para obtener todas las claves
  async getAllKeys() {
    try {
      return await AsyncStorage.getAllKeys();
    } catch (error) {
      console.error('Error getting keys:', error);
      return [];
    }
  },

  // M√©todo para obtener m√∫ltiples valores
  async multiGet(keys) {
    try {
      const keyValuePairs = await AsyncStorage.multiGet(keys);
      // Convertimos el array de pares [key, value] a un objeto
      return keyValuePairs.reduce((result, [key, value]) => {
        result[key] = value ? JSON.parse(value) : null;
        return result;
      }, {});
    } catch (error) {
      console.error('Error getting multiple items:', error);
      return {};
    }
  },

  // M√©todo para guardar m√∫ltiples valores
  async multiSet(keyValuePairs) {
    try {
      // Convertimos el objeto a pares [key, value] con JSON.stringify
      const pairs = Object.entries(keyValuePairs).map(([key, value]) => [
        key,
        JSON.stringify(value)
      ]);
      await AsyncStorage.multiSet(pairs);
    } catch (error) {
      console.error('Error setting multiple items:', error);
      throw error;
    }
  }
};
```

### 2. Explicaci√≥n L√≠nea por L√≠nea del Servicio

#### **Importaci√≥n:**
```javascript
import AsyncStorage from '@react-native-async-storage/async-storage';
```
- **Explicaci√≥n**: Importamos la librer√≠a AsyncStorage que nos permite acceder al almacenamiento nativo del dispositivo
- **¬øPor qu√© es necesario?**: Sin esta importaci√≥n, no podemos usar las funciones de almacenamiento

#### **Estructura del Objeto:**
```javascript
export const storage = {
  // m√©todos aqu√≠...
};
```
- **Explicaci√≥n**: Creamos un objeto que contiene todos nuestros m√©todos de almacenamiento
- **¬øPor qu√© exportamos?**: Para poder importarlo en otros archivos y reutilizarlo

#### **M√©todo setItem:**
```javascript
async setItem(key, value) {
  try {
    await AsyncStorage.setItem(key, JSON.stringify(value));
  } catch (error) {
    console.error('Error saving data:', error);
    throw error;
  }
}
```
- **`async`**: Hace que la funci√≥n sea as√≠ncrona, permitiendo usar `await`
- **`key`**: La clave (string) bajo la cual se guardar√° el valor
- **`value`**: El valor que queremos guardar (puede ser cualquier tipo)
- **`JSON.stringify(value)`**: Convierte el valor a string (AsyncStorage solo acepta strings)
- **`try-catch`**: Captura errores que puedan ocurrir durante el guardado
- **`throw error`**: Re-lanza el error para que el componente que lo llam√≥ pueda manejarlo

#### **M√©todo getItem:**
```javascript
async getItem(key) {
  try {
    const value = await AsyncStorage.getItem(key);
    
    if (value === null) {
      return null;
    }
    
    return JSON.parse(value);
  } catch (error) {
    console.error('Error reading data:', error);
    return null;
  }
}
```
- **`await AsyncStorage.getItem(key)`**: Obtiene el valor almacenado bajo la clave especificada
- **`value === null`**: Verifica si no hay valor almacenado
- **`JSON.parse(value)`**: Convierte el string de vuelta a su tipo original
- **`return null`**: Retorna null en caso de error o si no hay valor

#### **M√©todo removeItem:**
```javascript
async removeItem(key) {
  try {
    await AsyncStorage.removeItem(key);
  } catch (error) {
    console.error('Error removing data:', error);
    throw error;
  }
}
```
- **`AsyncStorage.removeItem(key)`**: Elimina el elemento almacenado bajo la clave especificada
- **Manejo de errores**: Si falla la eliminaci√≥n, lanzamos el error

#### **M√©todo clear:**
```javascript
async clear() {
  try {
    await AsyncStorage.clear();
  } catch (error) {
    console.error('Error clearing data:', error);
    throw error;
  }
}
```
- **`AsyncStorage.clear()`**: Elimina TODOS los datos almacenados
- **‚ö†Ô∏è Precauci√≥n**: Este m√©todo es destructivo, usar con cuidado

#### **M√©todo getAllKeys:**
```javascript
async getAllKeys() {
  try {
    return await AsyncStorage.getAllKeys();
  } catch (error) {
    console.error('Error getting keys:', error);
    return [];
  }
}
```
- **`AsyncStorage.getAllKeys()`**: Obtiene un array con todas las claves almacenadas
- **Retorno en error**: Si falla, retornamos un array vac√≠o

#### **M√©todo multiGet:**
```javascript
async multiGet(keys) {
  try {
    const keyValuePairs = await AsyncStorage.multiGet(keys);
    return keyValuePairs.reduce((result, [key, value]) => {
      result[key] = value ? JSON.parse(value) : null;
      return result;
    }, {});
  } catch (error) {
    console.error('Error getting multiple items:', error);
    return {};
  }
}
```
- **`AsyncStorage.multiGet(keys)`**: Obtiene m√∫ltiples valores en una sola operaci√≥n (m√°s eficiente)
- **`reduce`**: Convierte el array de pares [key, value] a un objeto
- **`value ? JSON.parse(value) : null`**: Si hay valor, lo parsea; si no, asigna null

#### **M√©todo multiSet:**
```javascript
async multiSet(keyValuePairs) {
  try {
    const pairs = Object.entries(keyValuePairs).map(([key, value]) => [
      key,
      JSON.stringify(value)
    ]);
    await AsyncStorage.multiSet(pairs);
  } catch (error) {
    console.error('Error setting multiple items:', error);
    throw error;
  }
}
```
- **`Object.entries(keyValuePairs)`**: Convierte el objeto en un array de pares [key, value]
- **`map`**: Convierte cada valor a string usando JSON.stringify
- **`AsyncStorage.multiSet(pairs)`**: Guarda m√∫ltiples valores en una sola operaci√≥n

---

## üí° Casos de Uso Pr√°cticos

### 1. Configuraci√≥n de Usuario

```javascript
// services/configService.js
import { storage } from '../utils/storage';

export const configService = {
  // Guardar tema de la aplicaci√≥n
  async saveTheme(theme) {
    // theme puede ser 'light', 'dark', o 'auto'
    await storage.setItem('theme', theme);
  },

  // Obtener tema guardado
  async getTheme() {
    // Si no hay tema guardado, retornamos 'light' por defecto
    return await storage.getItem('theme') || 'light';
  },

  // Guardar idioma
  async saveLanguage(language) {
    await storage.setItem('language', language);
  },

  // Obtener idioma
  async getLanguage() {
    return await storage.getItem('language') || 'es';
  },

  // Guardar preferencias completas del usuario
  async saveUserPreferences(preferences) {
    // preferences es un objeto con m√∫ltiples configuraciones
    await storage.setItem('userPreferences', preferences);
  },

  // Obtener preferencias del usuario
  async getUserPreferences() {
    return await storage.getItem('userPreferences') || {};
  }
};
```

### 2. Gesti√≥n de Sesi√≥n

```javascript
// services/sessionService.js
import { storage } from '../utils/storage';

export const sessionService = {
  // Guardar token de autenticaci√≥n
  async saveAuthToken(token) {
    await storage.setItem('authToken', token);
  },

  // Obtener token de autenticaci√≥n
  async getAuthToken() {
    return await storage.getItem('authToken');
  },

  // Eliminar token (logout)
  async clearAuthToken() {
    await storage.removeItem('authToken');
  },

  // Verificar si el usuario est√° autenticado
  async isAuthenticated() {
    const token = await this.getAuthToken();
    return token !== null;
  },

  // Guardar informaci√≥n del usuario
  async saveUserInfo(userInfo) {
    await storage.setItem('userInfo', userInfo);
  },

  // Obtener informaci√≥n del usuario
  async getUserInfo() {
    return await storage.getItem('userInfo');
  }
};
```

---

## üìù Ejercicios Pr√°cticos

### **Ejercicio 1: Implementaci√≥n B√°sica**
1. Crea el archivo `utils/storage.js` con el servicio completo
2. Implementa los m√©todos `setItem`, `getItem`, `removeItem` y `clear`
3. Prueba cada m√©todo con diferentes tipos de datos
4. Maneja los errores apropiadamente

### **Ejercicio 2: Servicio de Configuraci√≥n**
1. Crea `services/configService.js` usando el storage service
2. Implementa m√©todos para guardar/obtener tema, idioma y preferencias
3. Crea un componente que use este servicio
4. Prueba la persistencia de datos

### **Ejercicio 3: Gesti√≥n de Sesi√≥n**
1. Crea `services/sessionService.js` para manejar autenticaci√≥n
2. Implementa login/logout simulado
3. Crea un componente que muestre el estado de autenticaci√≥n
4. Prueba la persistencia del token

### **Ejercicio 4: Cache de Datos**
1. Crea un servicio de cache que use AsyncStorage
2. Implementa TTL (Time To Live) para los datos
3. Crea m√©todos para limpiar cache expirado
4. Prueba con datos simulados de API

### **Ejercicio 5: Manejo de Errores Avanzado**
1. Implementa retry logic para operaciones fallidas
2. Crea un sistema de logging para errores de storage
3. Implementa fallback a valores por defecto
4. Prueba con diferentes escenarios de error

---

## üéØ Proyecto de la Clase

### **App de Configuraci√≥n Personalizable**

Crea una aplicaci√≥n que permita al usuario:
1. **Cambiar tema** (claro/oscuro)
2. **Seleccionar idioma** (espa√±ol/ingl√©s)
3. **Configurar notificaciones** (on/off, horarios)
4. **Personalizar colores** de la interfaz
5. **Guardar preferencias** de accesibilidad

**Estructura del Proyecto:**
```
src/
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ storage.js          # Servicio de almacenamiento
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ configService.js    # Servicio de configuraci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ sessionService.js   # Servicio de sesi√≥n
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ThemeToggle.js      # Selector de tema
‚îÇ   ‚îú‚îÄ‚îÄ LanguageSelector.js # Selector de idioma
‚îÇ   ‚îî‚îÄ‚îÄ SettingsForm.js     # Formulario de configuraci√≥n
‚îî‚îÄ‚îÄ screens/
    ‚îî‚îÄ‚îÄ SettingsScreen.js   # Pantalla de configuraci√≥n
```

---

## üìö Recursos Adicionales

### **Documentaci√≥n Oficial:**
- [AsyncStorage Documentation](https://react-native-async-storage.github.io/async-storage/)
- [React Native Storage Guide](https://reactnative.dev/docs/asyncstorage)

### **Mejores Pr√°cticas:**
- **Tama√±o de datos**: Evita guardar archivos grandes
- **Frecuencia de escritura**: No escribas en cada render
- **Manejo de errores**: Siempre implementa try-catch
- **Validaci√≥n**: Verifica los datos antes de guardarlos

### **Alternativas:**
- **MMKV**: Para datos que requieren alto rendimiento
- **WatermelonDB**: Para bases de datos complejas
- **Realm**: Para datos estructurados y relaciones

---

## üîç Resumen de la Clase

### **Conceptos Clave:**
- ‚úÖ AsyncStorage es ideal para datos simples clave-valor
- ‚úÖ Siempre usar try-catch para manejar errores
- ‚úÖ JSON.stringify/parse para convertir datos
- ‚úÖ Los m√©todos son as√≠ncronos (async/await)
- ‚úÖ Crear servicios reutilizables para el almacenamiento

### **Pr√≥ximos Pasos:**
- üîÑ Completar todos los ejercicios de esta clase
- üîÑ Implementar el proyecto de configuraci√≥n
- üîÑ Practicar con diferentes tipos de datos
- üîÑ Prepararse para la siguiente clase sobre SQLite

---

## üöÄ Siguiente Clase

En la **Clase 2: SQLite - Base de Datos Relacional**, aprender√°s:
- C√≥mo configurar SQLite en React Native
- Creaci√≥n y gesti√≥n de tablas
- Operaciones CRUD complejas
- Relaciones entre tablas
- Migraciones y versionado de base de datos

---

**¬°Excelente trabajo en esta primera clase! üéâ**

**Recuerda**: AsyncStorage es la base del almacenamiento local. Domina estos conceptos antes de avanzar a bases de datos m√°s complejas.
